<!doctype html>
<html lang="en">
  <head>
    <title>Shinjuku Gourmet Spots</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="  crossorigin="anonymous"></script>
    <link href="mycss.css" rel="stylesheet">
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js'></script>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#">Shinjuku  Gourmet Spots</a>
      </nav>
    </header>
    <div class="container-fluid">
      <div class="row">
        <div class="col-2">
          <form class="bd-search d-flex align-items-center">
            <input data-bind="value: filteredValue" class="form-control mr-sm-2" type="text" placeholder="Search" aria-label="Search">
            <button class="btn btn-link bd-search-docs-toggle d-md-none p-0 ml-3" type="button" data-toggle="collapse" data-target="#bd-docs-nav" aria-controls="bd-docs-nav" aria-expanded="false" aria-label="Toggle docs navigation">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="30" height="30" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-miterlimit="10" d="M4 7h22M4 15h22M4 23h22"></path></svg>
              </button>
          </form>
          <nav class="navbar-expand bd-links" id="bd-docs-nav">
            <ul class="nav nav-pills flex-column" data-bind="foreach: filteredArray">
              <li class="nav-item">
                <a class="nav-link" href="#" data-bind="click: $parent.moreInfo"><span data-bind="text: title"></span></a>
              </li>
            </ul>
            <div class="card" style="width: 15rem;"  data-bind="visible: shouldShowCard">
              <img class="card-img-top"  data-bind="attr:{src: img_url, alt:img_alt}" >
              <div class="card-body">
                <h5 class="card-title" data-bind="text: venue_name"></h5>
                <span class="badge badge-success" data-bind="text: venue_rate"></span>
                <p class="card-text">
                  <span data-bind="text: venue_category"><span>
                </p>
                <a data-bind="attr: { href: venue_url, title: venue_details }" target="_blank" class="btn btn-primary">More on Foursquare</a>
              </div>

              </div>

              <div class="alert alert-danger" role="alert" data-bind="visible: shouldShowAlert">
                Sorry, we are not able to load the information about this venue. Please try again later.

              </div>

        </nav>










        </div>
        <main  role="main" >
          <div id="map">
          </div>
        </main>
      </div>
    </div>
    <img id="fs_logo" width="200" src="Powered-by-Foursquare-one-color-600_preview.png" />





    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
    <script>
    let locations = [
      {title: 'Nabezo Shinjuku Sanchome Store', address: '日本〒160-0022 Tokyo, Shinjuku, 3 Chome−30−11, 新宿 高野 第 二 ビル 8F', location:{"lat":35.6911434,"lng":139.70362239999997}, foursquare_id:"4b5ec803f964a520829829e3"},
      {title: 'Rokkasen BBQ', address: '日本〒160-0023 Tokyo, Shinjuku, Nishishinjuku, 1 Chome−3−1, 新宿サンフラワービル', location:{"lat":35.6938401,"lng":139.70354940000004},foursquare_id:"4b76ac08f964a520a4572ee3"},
      {title: 'Teppan Baby', address: '1 Chome-17-4 Pocket Bldg. B1F,, Kabukicho, Shinjuku, Tokyo 160-0021日本', location:{"lat":35.6960834,"lng":139.70262509999998},foursquare_id:"588f32124988da5852e97d93"},
      {title: 'Ichiran Ramen', address: '日本〒160-0022 Tokyo, Shinjuku, 3 Chome−34−11, ピースビル', location:{"lat":35.69053,"lng":139.7027647}, foursquare_id:"4b5a5bc9f964a520cbbf28e3"},
      {title: 'Tsukiji Kiyomura Sushi Zanmai Higashi Shinjuku', address: '日本〒169-0072 Tokyo, 新宿区Okubo, 1 Chome−1−13, ベルバウム', location:{"lat":35.6938401,"lng":139.70354940000004},foursquare_id:"4b64158af964a5204a9e2ae3"},
    ];
    let selectedLocation;
    let markers = [];
    let map;
    function initMap() {
      let largeInfowindow = new google.maps.InfoWindow();
      let shinjuku = {lat: 35.6915, lng: 139.7081};
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: shinjuku
      });

      // Style the markers a bit. This will be our listing marker icon.
      var defaultIcon = makeMarkerIcon('0091ff');
      // Create a "highlighted location" marker color for when the user
      // mouses over the marker.
      var highlightedIcon = makeMarkerIcon('FFFF24');
      // The following group uses the location array to create an array of markers on initialize.
      for (var i = 0; i < locations.length; i++) {
        // Get the position from the location array.

        var position = locations[i].location;
        //console.log(JSON.stringify(position));
        var title = locations[i].title;
        var foursquare_id = locations[i].foursquare_id;
        // Create a marker per location, and put into markers array.
        var marker = new google.maps.Marker({
          position: position,
          title: title,
          map: map,
          animation: google.maps.Animation.DROP,
          icon: defaultIcon,
          id: i
        });
        // Push the marker to our array of markers.
        // Create an onclick event to open the large infowindow at each marker.
        marker.addListener('click', (function(foursquare_id_copy) {
          return function() {
            populateInfoWindow(this, largeInfowindow);
            getStoreInfo(foursquare_id_copy);
          };
        })(foursquare_id));



        // Two event listeners - one for mouseover, one for mouseout,
        // to change the colors back and forth.
        marker.addListener('mouseover', function() {
          this.setIcon(highlightedIcon);
        });
        marker.addListener('mouseout', function() {
          this.setIcon(defaultIcon);
        });
        markers.push(marker);
      }
    }
    function populateInfoWindow(marker, infowindow) {
      // Check to make sure the infowindow is not already opened on this marker.
      if (infowindow.marker != marker) {
        infowindow.marker = marker;
        infowindow.setContent('<div>' + marker.title + '</div>');
        infowindow.open(map, marker);
        // Make sure the marker property is cleared if the infowindow is closed.
        infowindow.addListener('closeclick',function(){
          infowindow.setMarker = null;
        });
      }
    }

    function highlightMarker(place){
      if (selectedLocation)
      {
      let resetMarker = markers.filter(item => item.title.search(selectedLocation.title)>-1)[0];
      resetMarker.setAnimation(null);
      }
      let highlightedMarker = markers.filter(item => item.title.search(place.title)>-1)[0];
      //console.log("highlightedMarker" + highlightedMarker);
      highlightedMarker.setAnimation(google.maps.Animation.BOUNCE);
      google.maps.event.trigger(highlightedMarker, 'click');
      setTimeout(function(){ highlightedMarker.setAnimation(null); }, 1400);
      //this.filteredArray(locations.filter(item => item.title.search(value) >-1));
      selectedLocation = place;
    }
    function applyFilter(placeArray){
      markers.forEach(function(marker) {
        marker.setMap(null);
      });

      placeArray.forEach(function(placeItem) {
        //console.log(placeItem.title);
        let xMarker = markers.filter(item => item.title.search(placeItem.title)>-1)[0];
        xMarker.setMap(map);
      });
    }
      // This function takes in a COLOR, and then creates a new marker
      // icon of that color. The icon will be 21 px wide by 34 high, have an origin
      // of 0, 0 and be anchored at 10, 34).
      function makeMarkerIcon(markerColor) {
        var markerImage = new google.maps.MarkerImage(
          'http://chart.googleapis.com/chart?chst=d_map_spin&chld=1.15|0|'+ markerColor +
          '|40|_|%E2%80%A2',
          new google.maps.Size(21, 34),
          new google.maps.Point(0, 0),
          new google.maps.Point(10, 34),
          new google.maps.Size(21,34));
        return markerImage;
      }


      function getStoreInfo(v_id)
      {
        MyViewModelObj.shouldShowAlert(false);
        //****** replace with your foursquare id & secret here
        let fs_client_id ="";
        let fs_client_secret ="";
        //******
        let url ="https://api.foursquare.com/v2/venues/"+ v_id +"?client_id="+ fs_client_id +"&client_secret="+ fs_client_secret +"&v=20170801";




        $.getJSON(url, function(data) {
          console.log('getStoreInfo' + JSON.stringify(data));
          if (data.meta.code === 200)
          {
            MyViewModelObj.venue_name(data.response.venue.name);
            MyViewModelObj.venue_url(data.response.venue.canonicalUrl);
            MyViewModelObj.img_url(data.response.venue.photos.groups[0].items[0].prefix +"200x200"+ data.response.venue.photos.groups[0].items[0].suffix);
            MyViewModelObj.venue_rate(data.response.venue.rating);
            MyViewModelObj.venue_category(data.response.venue.categories[0].name);

            MyViewModelObj.shouldShowCard(true);

            // console.log(data.response.venue.name);
            // console.log(data.response.venue.categories[0].name);
            // console.log(data.response.venue.rating);
            // console.log(data.response.venue.canonicalUrl);
            // console.log(data.response.venue.photos.groups[0].items[0].prefix);
            // console.log(data.response.venue.photos.groups[0].items[0].suffix);
          }
          else {
            MyViewModelObj.shouldShowAlert(true);
            console.log("error occured while loading data");
          }
            // Now use this data to update your view models,
            // and Knockout will update your UI automatically
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          //console.log('getStoreInfo' + JSON.stringify(jqXHR));
          //console.log('getStoreInfo' + JSON.stringify(textStatus));
          MyViewModelObj.shouldShowAlert(true);
          console.log('getStoreInfo' + JSON.stringify(errorThrown));
        });
      }

    </script>

    <script>
      function MyViewModel() {
        var self = this;
        self.moreInfo = function(place) {
              highlightMarker(place);
              //getStoreInfo(place.foursquare_id);

          };
          self.shouldShowCard = ko.observable(false), // Message initially visible
          self.shouldShowAlert = ko.observable(false), // Message initially visible

          self.venue_name=ko.observable();
          self.venue_url=ko.observable();
          self.venue_details=ko.observable();
          self.venue_category=ko.observable();
          self.venue_rate=ko.observable();
          self.img_url=ko.observable();
          self.img_alt=ko.observable();
          self.filteredArray = ko.observableArray(locations);
          self.filteredValue = ko.pureComputed({
              read: function () {
              },
              write: function (value) {
                  if (value)
                  {
                    this.filteredArray(locations.filter(item => item.title.search(value) >-1));
                  }
                  else {
                    //console.log('no value');
                    this.filteredArray(locations);
                  }
                  applyFilter(this.filteredArray());
              },
              owner: this
          });
      }
      let MyViewModelObj =  new MyViewModel();
      ko.applyBindings(MyViewModelObj);


    </script>
    <script async defer
        src=
        "https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyDFkJJDaYnYKCoY3tbLugTjuGEsK3vB5TI&v=3&callback=initMap">
    </script>
  </body>
</html>
